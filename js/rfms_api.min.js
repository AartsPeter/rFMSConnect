var Global_Check = {};

function UpdateCounter (Counter,Reference){
    var $Info = $('#'+Reference);$Info.html('');$Info.append(Counter);
}
function Create_APICard($r,$d) {
    var $CInfo = $('#' + $r);
    $CInfo.append('<div class="col-12 col-md-4 col-xl-3" id="API_Card_'+ $d.id +'"></div>');
}
function Update_APICard($d,$s) {
    var $UInfo = $('#API_Card_' + $d.id);
    $UInfo.html('');

    if ($s=='true')     { $b='success api-active';$tt='light';    $t='success';  $l='circle-notch fa-spin'; }
    if ($s=='false')    { $b='secondary';         $tt='light';    $t='secondary';$l='calendar-check text-success'; }
    if ($s=='error')    { $b='warning';           $tt='secondary';$t='danger';   $l='exclamation-triangle text-danger'; }
    if ($s=='stop')     { $b=' alert-secondary';  $tt='secondary';$t='secondary';$l='calendar-times text-secondary'; }

    $str = '   <a class="card-click" href="#" onclick="BuildAPIMonitor(`'+$d.name_EndPoint+'`,`'+$d.id+'`,`'+$s+'`);">';
    $str += '   <div class="card border-0 mb-3 ">';
    $str += '       <div class="card-header bg-'+$b+' text-'+$tt+' " >' + $d.name_EndPoint + '</div>';
    $str += '       <div class="card-body alert-'+$b+' text-'+$t+' p-2 px-3">';
    $str += '            <div class="d-flex">';
    $str += '               <div class="col-2 p-0"><i class="fas fa-'+$l+'"></i></div>';
    if ($s=='error'){
        $str += '               <div class="ml-auto text-right text-danger small"><b>'+ShowError($d.lastStatus)+'</b></div>';
    } else {
        $str += '               <div class="ml-auto text-right small">'+$d.lastExecution+'</div>';
    }
    $str += '            </div>';
    $str += '       </div>';
    $str += '   </div>';
    $str += ' </div></a>';

    $UInfo.append($str);
}
function API_Card($r,$s,$d) {
    var $HInfo = $('#' + $r);
    var myEle = document.getElementById("API_Card_"+$d.id);
    if(myEle){
        if ($d.CollectorActive == '0' || $d.installed == '0'){
            document.getElementById("API_Card_"+$d.id).remove();
        } else {
            Update_APICard($d,$s);}
    } else {
        if ($d.CollectorActive == '1' && $d.installed == '1'){
        Create_APICard($r,$d);
        Update_APICard($d,$s);}
    }
}

function ReadSchedule(){
    UpdateCounter('<i class="fad fa-spinner-third fa-spin text-primary"></i>','result');
    $.ajax({
        url: window.location.origin+'/scripts/GetAPIDaemonScheduler.php',
        type:'GET',
        dataType:'json',
        success:function(data){
            $.each(data, function (key, val) {
                if (val.active == 0) { $status = 'stop';}
                else { if (val.running == 0) { $status = 'false';} else { $status = 'true';} }
                if (val.typeId == '999') { $ref = 'SystemScheduler';}
                else {
                    $ref = 'APIScheduler';
                }
                if (parseInt(val.lastStatus) > 200) { $status = 'error';}
				API_Card($ref,$status,val);
            })
            UpdateCounter('','result');
        },
        error:function(data){
        }
    });

}

function CheckDaemon(){
    $.ajax({
        url: window.location.origin+'/scripts/GetAPIDaemonStatus.php',
        type: 'GET',
        dataType: 'json',
        success: function (data) {
            $.each(data, function (key, val) {
                if (val.active==true) {
                    var $str = '<div class = "badge badge-pill bg-success p-2 normalFont shadow-sm" title=" id / domain ' + val.id+'/'+ val.domain + '"> <i class ="fad fa-play fa-fw " aria-hidden = "true"></i> Daemon Active <small>(' + val.activation_date + ')</small> </div>';
                    UpdateCounter($str, 'DaemonStatus');
                }
            })
        }
    })
}

function ReadLogging(){
    $.ajax({
        url: window.location.origin+'/scripts/GetAPILogging.php',
        type: 'GET',
        dataType: 'json',
        success: function (dataSet) {
            var table =$('#tableLogging').DataTable( { data: dataSet,
                createdRow: function( row, data, dataIndex ) {
                    if (data.Status != 200 ) 		{ $(row).addClass('cell_bold text-danger');}},
                oLanguage: {sProcessing: "<div class='loader' id='tableloader'></div>"}, processing: true,paging: false,pageResize: true,"searching": false,"bLengthChange": false,
                    autoWidth: false,destroy:true,order:[[0,'desc' ]],dom: 'Bfltirp',bInfo: false, scrollCollapse: false,scrollX: true,deferRender: true,
                    buttons: {buttons: []},
                columns: [
                    { "data": "DateTime",		"title":"date",	    "defaultContent": "", "width":"25%", "className":"dt-left"},
                    { "data": "Endpoint",   	"title":"endpoint",	"defaultContent": "", "visible":true, "className":"dt-left"},
                    { "data": "Status",	        "title":"status",	"defaultContent": "", "visible":true, "className":"dt-center"},
                    { "data": "rt",	            "title":"time",		"defaultContent": "","className":"dt-right" },
                    { "data": "ro",	            "title":"objects",	"defaultContent": "","className":"dt-right" },
                ]
            } );
            $('#tableLogging').off('click');
        }
    })
}

function ShowError($s){
    var $t='';
    var $e=[
            {'httpstatus':'400','text':'Bad Request'},
            {'httpstatus':'401','text':'Unauthorized'},
            {'httpstatus':'403','text':'Forbidden'},
            {'httpstatus':'404','text':'Not Found'},
            {'httpstatus':'405','text':'Method Not Allowed'},
            {'httpstatus':'407','text':'Proxy Authentication required'},
            {'httpstatus':'408','text':'Request Timeout'},
            {'httpstatus':'416','text':'Requested range not Satisfiable'},
            {'httpstatus':'413','text':'Payload too large'},
            {'httpstatus':'415','text':'Unsupported mediatype'},
            {'httpstatus':'423','text':'Locked'},
            {'httpstatus':'429','text':'Too Many Requests'},
            {'httpstatus':'500','text':'Internal Server Error'},
            {'httpstatus':'502','text':'Bad Gateway'},
            {'httpstatus':'503','text':'Service Unavailable'},
            {'httpstatus':'504','text':'Gateway Timeout'}
    ];
    var $r=$e.filter(p => p.httpstatus == $s);
    if ($r.length>0){ $t=$r[0].httpstatus+'-'+$r[0].text;};
    return $t;
}

function BuildAPIMonitor($n,$id,$s) {
    UpdateCounter('<i class="fad fa-spinner-third fa-spin text-primary"></i>','resultm');
    var $MInfo = $('#monitoring');
    $MInfo.html('');var $d="";
    var $val=[];
    $val['id']=$id;
    $val['hours']=24;
    $val['name_EndPoint']=$n;
    if ($s=='true')     { $b='success';  $tt='light';  }
    if ($s=='false')    { $b='secondary';$tt='light';  }
    if ($s=='error')    { $b='warning';  $tt='secondary';  }
    if ($s=='stop')     { $b=' alert-secondary';  $tt='secondary'; }
    $d += '		<div class="card-header bg-'+ $b +' text-'+$tt+' ">' + $n + ' last '+$val.hours+' hours</div>';
    $d += '		<div class="card-body p-0 py-2 d-flex">';
    $d += '			<div id="Stat_' + $id + '" class="rFMSStats col-12 col-md-4 p-0 small">' + $id + '</div>';
    $d += '			<div id="Perf_' + $id + '" class="rFMSGraph col-12 col-md-8 p-0 ">' + $id + '</div>';
    $d += '		</div>';
    $MInfo.append($d);
    ReadPerformanceLog($val);
    UpdateCounter('','resultm');
}